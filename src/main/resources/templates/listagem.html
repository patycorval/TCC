<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
    </style>
    <title>Minhas Reservas</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Minhas Reservas</h1>
            <form th:action="@{/listagem}" method="get" class="d-flex align-items-center">
                <select name="periodo" class="form-select w-auto" onchange="this.form.submit()">
                    <option value="15dias" th:selected="${periodoSelecionado == '15dias'}">Próximos 15 dias</option>
                    <option value="30dias" th:selected="${periodoSelecionado == '30dias'}">Próximos 30 dias</option>
                    <option value="proximas" th:selected="${periodoSelecionado == 'proximas'}">Todas as Próximas</option>
                    <option value="anteriores" th:selected="${periodoSelecionado == 'anteriores'}">Todas as Anteriores</option>
                </select>
            </form>
        </div>

        <h3 class="mt-5">Salas e Laboratórios</h3>
        <div class="card shadow-sm">
            <div class="card-body">
                <div th:if="${#lists.isEmpty(reservasSalas)}" class="alert alert-info">
                    Você não possui reservas de salas ou laboratórios para o período selecionado.
                </div>
                <div class="table-responsive" th:if="${not #lists.isEmpty(reservasSalas)}">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Sala/Lab</th>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>Status</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="reserva : ${reservasSalas}">
                                <td th:text="${reserva.numero}"></td>
                                <td th:text="${#temporals.format(reserva.data, 'dd/MM/yyyy')}"></td>
                                <td th:text="${#temporals.format(reserva.hora, 'HH:mm') + ' - ' + #temporals.format(reserva.horaFim, 'HH:mm')}"></td>
                                <td>
                                    <span class="badge bg-success" th:text="${reserva.status}"></span>
                                </td>
                                <td class="text-center">
                                    <a th:href="@{'/reservas/editar/' + ${reserva.id}}" class="btn btn-secondary btn-sm" title="Editar Reserva">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-danger btn-sm btn-apagar" th:attr="data-id=${reserva.id}" title="Cancelar Reserva">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h3 class="mt-5">Auditório</h3>
        <div class="card shadow-sm">
            <div class="card-body">
                <div th:if="${#lists.isEmpty(reservasAuditorio)}" class="alert alert-info">
                    Você não possui reservas do auditório para o período selecionado.
                </div>
                <div class="table-responsive" th:if="${not #lists.isEmpty(reservasAuditorio)}">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Evento</th>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>Status</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="reserva : ${reservasAuditorio}">
                                <td th:text="${reserva.evento}"></td>
                                <td th:text="${#temporals.format(reserva.data, 'dd/MM/yyyy')}"></td>
                                <td th:text="${#temporals.format(reserva.hora, 'HH:mm') + ' - ' + #temporals.format(reserva.horaFim, 'HH:mm')}"></td>
                                <td>
                                    <span th:classappend="${reserva.status.name() == 'APROVADA'} ? 'bg-success' : (${reserva.status.name() == 'PENDENTE'} ? 'bg-warning text-dark' : 'bg-danger')" class="badge" th:text="${reserva.status}">
                                    </span>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm btn-apagar" th:attr="data-id=${reserva.id}" title="Cancelar Reserva">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p>Tem certeza que deseja cancelar esta reserva?</p>
            <div class="modal-buttons">
                <button id="btnConfirm" class="btn">Sim</button>
                <button id="btnCancel" class="btn">Não</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.getElementById("confirmModal");
            const btnConfirm = document.getElementById("btnConfirm");
            const btnCancel = document.getElementById("btnCancel");
            let reservaIdParaExcluir = null;

            document.querySelectorAll(".btn-apagar").forEach((botao) => {
                botao.addEventListener("click", () => {
                    reservaIdParaExcluir = botao.getAttribute("data-id");
                    modal.style.display = "flex";
                });
            });

            btnCancel.addEventListener("click", () => {
                modal.style.display = "none";
                reservaIdParaExcluir = null;
            });

            btnConfirm.addEventListener("click", () => {
                if (reservaIdParaExcluir) {
                    const form = document.createElement("form");
                    form.method = "post";
                    form.action = "/deletar/" + reservaIdParaExcluir;
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "_csrf";
                    input.value = csrfToken;
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            });

            window.addEventListener("click", (event) => {
                if (event.target == modal) {
                    modal.style.display = "none";
                    reservaIdParaExcluir = null;
                }
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>